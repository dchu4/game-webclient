var cursors;
var attackButton;
var charObj;
var charText = [];
var deadCharText = [];

var enemyText = [];

var enemyButton1;
var enemyButton2;
var enemyButton3;
var enemyButton4;
var enemyButton5;

var current_unit;

var deadChars = [];
var deadEnemys = [];

// var charsArray = [
//       {
//         name: "Clarence", 
//         unitType: "Warrior", 
//         charHp: 400, 
//         charAttack: 20, 
//         alive: true, 
//         isNpc: false,
//         act: function(){
//           if(this.isNpc == false){
//             attackButton.visible = true;
//             //console.log(attackButton.visible);
//           }
//           if(this.isNpc == true){
//             attackButton.visble = false;
//           }
//         }
//       },
//       {
//         name: "Bob", 
//         unitType: "Rogue", 
//         charHp: 200, 
//         charAttack: 40, 
//         alive: true, 
//         isNpc: false,
//         act: function(){
//           if(this.isNpc == false){
//             attackButton.visible = true;
//             //console.log(attackButton.visible);
//           }
//           if(this.isNpc == true){
//             attackButton.visble = false;
//           }
//         }
//       },
//       {
//         name: "Nyan Cat", 
//         unitType: "Beast Tamer", 
//         charHp: 200, 
//         charAttack: 60, 
//         alive: true, 
//         isNpc: false,
//         act: function(){
//           if(this.isNpc == false){
//             attackButton.visible = true;
//             //console.log(attackButton.visible);
//           }
//           if(this.isNpc == true){
//             attackButton.visble = false;
//           }
//         }
//       },
//       {
//         name: "Chewy", 
//         unitType: "Wookie", 
//         charHp: 300, 
//         charAttack: 100, 
//         alive: true, 
//         isNpc: false,
//         act: function(){
//           if(this.isNpc == false){
//             attackButton.visible = true;
//             //console.log(attackButton.visible);
//           }
//           if(this.isNpc == true){
//             attackButton.visble = false;
//           }
//         }
//       }
//     ];

// var enemysArray = [
//       {
//         name: "The Blob", 
//         unitType: "Slime", 
//         charHp: 200, 
//         charAttack: 20, 
//         alive: true, 
//         isNpc: true,
//         act: function(){
//           if(this.isNpc == false){
//             attackButton.visible = true;
//             //console.log(attackButton.visible);
//           }
//           if(this.isNpc == true){
//             attackButton.visble = false;
//             arrayLength = charsArray.length;

//             var charIndex = Math.floor(Math.random() * arrayLength);

//             charsArray[charIndex].charHp = charsArray[charIndex].charHp - current_unit.charAttack;

//             if(charsArray[charIndex].charHp < 1){
//               charsArray[charIndex].alive = false;
//               charsArray[charIndex].charHp = 0;
//               console.log("IT attacks " + charsArray[charIndex].name);
//               charText[charIndex].setText(charsArray[charIndex].name + "\n" + charsArray[charIndex].charHp);
//               deadChars.push(charsArray.splice(charIndex,1));
//               deadCharText.push(charText.splice(charIndex,1));
//               return;
//             }

//             console.log("IT attacks " + charsArray[charIndex].name);
//             charText[charIndex].setText(charsArray[charIndex].name + "\n" + charsArray[charIndex].charHp);
//             //next_turn();
//           }
//         }
//       },
//       {
//         name: "Clamps", 
//         unitType: "Robot", 
//         charHp: 400, 
//         charAttack: 50, 
//         alive: true, 
//         isNpc: true,
//         act: function(){
//           if(this.isNpc == false){
//             attackButton.visible = true;
//             //console.log(attackButton.visible);
//           }
//           if(this.isNpc == true){
//             attackButton.visble = false;
//             arrayLength = charsArray.length;

//             var charIndex = Math.floor(Math.random() * arrayLength);

//             charsArray[charIndex].charHp = charsArray[charIndex].charHp - current_unit.charAttack;

//             if(charsArray[charIndex].charHp < 1){
//               charsArray[charIndex].alive = false;
//               charsArray[charIndex].charHp = 0;
//               console.log("IT attacks " + charsArray[charIndex].name);
//               charText[charIndex].setText(charsArray[charIndex].name + "\n" + charsArray[charIndex].charHp);
//               deadChars.push(charsArray.splice(charIndex,1));
//               deadCharText.push(charText.splice(charIndex,1));
//               return;
//             }

//             console.log("IT attacks " + charsArray[charIndex].name);
//             charText[charIndex].setText(charsArray[charIndex].name + "\n" + charsArray[charIndex].charHp);
//             //next_turn();
//           }
//         }
//       },
//       {
//         name: "Scrooge", 
//         unitType: "Person", 
//         charHp: 500, 
//         charAttack: 40, 
//         alive: true, 
//         isNpc: true,
//         act: function(){
//           if(this.isNpc == false){
//             attackButton.visible = true;
//             //console.log(attackButton.visible);
//           }
//           if(this.isNpc == true){
//             attackButton.visble = false;

//             arrayLength = charsArray.length;

//             var charIndex = Math.floor(Math.random() * arrayLength);

//             charsArray[charIndex].charHp = charsArray[charIndex].charHp - current_unit.charAttack;

//             if(charsArray[charIndex].charHp < 1){
//               charsArray[charIndex].alive = false;
//               charsArray[charIndex].charHp = 0;
//               console.log("IT attacks " + charsArray[charIndex].name);
//               charText[charIndex].setText(charsArray[charIndex].name + "\n" + charsArray[charIndex].charHp);
//               deadChars.push(charsArray.splice(charIndex,1));
//               deadCharText.push(charText.splice(charIndex,1));
//               return;
//             }

//             console.log("IT attacks " + charsArray[charIndex].name);
//             charText[charIndex].setText(charsArray[charIndex].name + "\n" + charsArray[charIndex].charHp);
//             //next_turn();
//           }
//         }
//       },
//       {
//         name: "Mr Crab", 
//         unitType: "Crab", 
//         charHp: 300, 
//         charAttack: 50, 
//         alive: true, 
//         isNpc: true,
//         act: function(){
//           if(this.isNpc == false){
//             attackButton.visible = true;
//             //console.log(attackButton.visible);
//           }
//           if(this.isNpc == true){
//             attackButton.visble = false;

//             arrayLength = charsArray.length;

//             var charIndex = Math.floor(Math.random() * arrayLength);

//             charsArray[charIndex].charHp = charsArray[charIndex].charHp - current_unit.charAttack;

//             if(charsArray[charIndex].charHp < 1){
//               charsArray[charIndex].alive = false;
//               charsArray[charIndex].charHp = 0;
//               console.log("IT attacks " + charsArray[charIndex].name);
//               charText[charIndex].setText(charsArray[charIndex].name + "\n" + charsArray[charIndex].charHp);
//               deadChars.push(charsArray.splice(charIndex,1));
//               deadCharText.push(charText.splice(charIndex,1));
//               return;
//             }

//             console.log("IT attacks " + charsArray[charIndex].name);
//             charText[charIndex].setText(charsArray[charIndex].name + "\n" + charsArray[charIndex].charHp);
//             //next_turn();
//           }
//         }
//       },
//       {
//         name: "IT", 
//         unitType: "Clown", 
//         charHp: 100, 
//         charAttack: 100, 
//         alive: true, 
//         isNpc: true,
//         act: function(){
//           if(this.isNpc == false){
//             attackButton.visible = true;
//             //console.log(attackButton.visible);
//           }
//           if(this.isNpc == true){
//             attackButton.visble = false;

//             arrayLength = charsArray.length;

//             var charIndex = Math.floor(Math.random() * arrayLength);

//             charsArray[charIndex].charHp = charsArray[charIndex].charHp - current_unit.charAttack;

//             if(charsArray[charIndex].charHp < 1){
//               charsArray[charIndex].alive = false;
//               charsArray[charIndex].charHp = 0;
//               console.log("IT attacks " + charsArray[charIndex].name);
//               charText[charIndex].setText(charsArray[charIndex].name + "\n" + charsArray[charIndex].charHp);
//               deadChars.push(charsArray.splice(charIndex,1));
//               deadCharText.push(charText.splice(charIndex,1));
//               return;
//             }

//             console.log("IT attacks " + charsArray[charIndex].name);
//             charText[charIndex].setText(charsArray[charIndex].name + "\n" + charsArray[charIndex].charHp);
//             //next_turn();


//             // for(var i = 0; i < charsArray.length; i++){
//             //   if(charsArray[i].charHp >= 1){
//             //     charsArray[i].charHp = charsArray[i].charHp - current_unit.charAttack;
//             //     if(charsArray[i].charHp < 1){
//             //       charsArray[i].alive = false;
//             //       charsArray[i].charHp = 0;
//             //     }
//             //     console.log("IT attacks " + charsArray[i].name);
//             //     charText[i].setText(charsArray[i].name + "\n" + charsArray[i].charHp);
//             //     next_turn();
//             //   }
//             // }
//             console.log("IT acted");
//             //game.state.start('loseState');
//           }
//         }
//       }
//     ];

var randomEnemys = [];
var userParty = [];

var unitsArray;

var actionMenu;
var enemyMenu;
var itemMenu;

var characters;

var battleState = {
  preload: function(){
    //game.cache.destroy();
    game.load.image('background','<%= asset_path "battle_phase.png" %>');
    game.load.image('attack','<%= asset_path "attack_button.png" %>');
    game.load.spritesheet('buttons', '<%= asset_path "buttons.png" %>',260,42);


    // characters = fetch('http://localhost:3000/characters.json')
    //   .then(function(response){
    //     return response.json();
    //   })
    //   .then(function(data){
    //     charObj = {
    //       name: data[0].character_name,
    //       charClass: data[0].character_class,
    //       charHp: 300,
    //       charAttack: data[0].attack,
    //       alive: true
    //     };

    //     //gameUnits.push(charObj);

    //     charText = game.add.text(50, 400,charObj.name + "\n" + charObj.charClass + "\n" + charObj.charHp, {font: "30px Arial", fill: "#ffffff", align: "center"});   

    //   });
  },
  create: function(){
    game.physics.startSystem(Phaser.Physics.ARCADE);
    game.add.sprite(0,0,'background');

    userParty.push(game.cache.charactersArray[0]);
    userParty.push(game.cache.charactersArray[1]);
    userParty.push(game.cache.charactersArray[2]);
    userParty.push(game.cache.charactersArray[3]);

    var setNum = (Math.floor(Math.random() * 7) + 1);
    var gameMobs = game.cache.enemysArray;

    for(var i = 0; i < gameMobs.length; i++){
      if(gameMobs[i].set == setNum){
        randomEnemys.push(gameMobs[i]);
      }
    }

    console.log(randomEnemys);
    console.log(userParty);
    unitsArray = userParty.concat(randomEnemys);
    actionMenu = game.add.group();
    enemyMenu = game.add.group();
    itemMenu = game.add.group();

    //set up enemy and char array over here

    enemyButton1 = game.add.button(280,428,'buttons',attackEnemyOne,this,4,4,4);
    enemyButton2 = game.add.button(280,470,'buttons',attackEnemyTwo,this,5,5,5);
    enemyButton3 = game.add.button(280,512,'buttons',attackEnemyThree,this,6,6,6);
    enemyButton4 = game.add.button(280,554,'buttons',attackEnemyFour,this,7,7,7);
    enemyButton5 = game.add.button(280,596,'buttons',attackEnemyFive,this,8,8,8);

    enemyButton1.onInputUp.add(attackEnemyOne,this);
    enemyButton2.onInputUp.add(attackEnemyTwo,this);
    enemyButton3.onInputUp.add(attackEnemyThree,this);
    enemyButton4.onInputUp.add(attackEnemyFour,this);
    enemyButton5.onInputUp.add(attackEnemyFive,this);

    enemyButton1.visible = false;
    enemyButton2.visible = false;
    enemyButton3.visible = false;
    enemyButton4.visible = false;
    enemyButton5.visible = false;

    //enemyButton1.onInputUp.add(attackFunction,this);

    attackButton = game.add.button(540,428,'buttons',attackFunction,this,0);
    //attackButton.setFrames(0);

    //attackButton.onInputUp.add(attackFunction, this);

    for(var i = 0; i < randomEnemys.length; i++){
         enemyText.push(game.add.text((180*i)+20, 20,randomEnemys[i].name + "\n" + "HP: " + randomEnemys[i].charHp, {font: "30px Arial", fill: "#ffffff", align: "center"}));
    }

    for(var i = 0; i < userParty.length; i++){
         charText.push(game.add.text((180*i)+20, 200,userParty[i].name + "\n" + "HP: " + userParty[i].charHp, {font: "30px Arial", fill: "#ffffff", align: "center"}));
    }

    actionMenu.add(attackButton);

    next_turn();

    //cursors = game.input.keyboard.createCursorKeys();

  },
  update: function(){
    if(!isAlive(userParty)){
      randomEnemys.splice(0);
      userParty.splice(0);
      deadEnemys.splice(0);
      charText.splice(0);
      deadCharText.splice(0);
      enemyText.splice(0);
      game.state.start('loseState');
    }

    if(!isAlive(randomEnemys)){
      randomEnemys.splice(0);
      userParty.splice(0);
      deadEnemys.splice(0);
      charText.splice(0);
      deadCharText.splice(0);
      enemyText.splice(0);
      game.state.start(game.cache.currentGameState);
    }
  }
};

var attackFunction = function(numbers){

  //enemyHolder.charHp = enemyHolder.charHp - charHolder.charAttack;
  toggleVisible();
 
}

var isAlive = function(arrayToCheck){
  var arrayLength = arrayToCheck.length;
  var totalHp = 0;
  var unitsAlive = true;

  for(var i = 0; i < arrayLength; i++){
    totalHp += arrayToCheck[i].charHp;
  }

  if(totalHp < 1){
    unitsAlive = false;
  }

  return unitsAlive;
}


var next_turn = function(){
  current_unit = unitsArray.shift();

  if(current_unit.alive){
    current_unit.act();
    console.log(current_unit.name + " does something");
    unitsArray.push(current_unit);
    if(current_unit.isNpc == true){
      next_turn();
    }
  }
  else{
    next_turn();
  }
}

var toggleVisible = function(){
  if(randomEnemys.length == 1){
    enemyButton1.visible = !enemyButton1.visible;
  }
  else if(randomEnemys.length == 2){
    enemyButton1.visible = !enemyButton1.visible;
    enemyButton2.visible = !enemyButton2.visible;
  }
  else if(randomEnemys.length == 3){
    enemyButton1.visible = !enemyButton1.visible;
    enemyButton2.visible = !enemyButton2.visible;
    enemyButton3.visible = !enemyButton3.visible;
  }
  else if(randomEnemys.length == 4){
    enemyButton1.visible = !enemyButton1.visible;
    enemyButton2.visible = !enemyButton2.visible;
    enemyButton3.visible = !enemyButton3.visible;
    enemyButton4.visible = !enemyButton4.visible;
  }
  else{
    enemyButton1.visible = !enemyButton1.visible;
    enemyButton2.visible = !enemyButton2.visible;
    enemyButton3.visible = !enemyButton3.visible;
    enemyButton4.visible = !enemyButton4.visible;
    enemyButton5.visible = !enemyButton5.visible;
  }
}

var attackEnemyOne = function(){
  randomEnemys[0].charHp = randomEnemys[0].charHp - current_unit.charAttack;
  if(randomEnemys[0].charHp < 1){
    randomEnemys[0].alive = false;
    randomEnemys[0].charHp = 0;

    enemyText[0].setText(randomEnemys[0].name + "\n" + "HP: " + randomEnemys[0].charHp);
    toggleVisible();

    randomEnemys.splice(0,1);
    enemyText.splice(0,1);

    next_turn();
  }
  enemyText[0].setText(randomEnemys[0].name + "\n" + "HP: " + randomEnemys[0].charHp);
  toggleVisible();
  next_turn();
}

var attackEnemyTwo = function(){
  randomEnemys[1].charHp = randomEnemys[1].charHp - current_unit.charAttack;
  if(randomEnemys[1].charHp < 1){
    randomEnemys[1].alive = false;
    randomEnemys[1].charHp = 0;

    enemyText[1].setText(randomEnemys[1].name + "\n" + "HP: " + randomEnemys[1].charHp);
    toggleVisible();

    randomEnemys.splice(1,1);
    enemyText.splice(1,1);

    next_turn();
  }
  enemyText[1].setText(randomEnemys[1].name + "\n" + "HP: " + randomEnemys[1].charHp);
  toggleVisible();
  next_turn();
}

var attackEnemyThree = function(){
  randomEnemys[2].charHp = randomEnemys[2].charHp - current_unit.charAttack;
  if(randomEnemys[2].charHp < 1){
    randomEnemys[2].alive = false;
    randomEnemys[2].charHp = 0;

    enemyText[2].setText(randomEnemys[2].name + "\n" + "HP: " + randomEnemys[2].charHp);
    toggleVisible();

    randomEnemys.splice(2,1);
    enemyText.splice(2,1);

    next_turn();
  }
  enemyText[2].setText(randomEnemys[2].name + "\n" + "HP: " + randomEnemys[2].charHp);
  toggleVisible();
  next_turn();
}

var attackEnemyFour = function(){
  randomEnemys[3].charHp = randomEnemys[3].charHp - current_unit.charAttack;
  if(randomEnemys[3].charHp < 1){
    randomEnemys[3].alive = false;
    randomEnemys[3].charHp = 0;

    enemyText[3].setText(randomEnemys[3].name + "\n" + "HP: " + randomEnemys[3].charHp);
    toggleVisible();

    randomEnemys.splice(3,1);
    enemyText.splice(3,1);

    next_turn();
  }
  enemyText[3].setText(randomEnemys[3].name + "\n" + "HP: " + randomEnemys[3].charHp);
  toggleVisible();
  next_turn();
}

var attackEnemyFive = function(){
  randomEnemys[4].charHp = randomEnemys[4].charHp - current_unit.charAttack;
  if(randomEnemys[4].charHp < 1){
    randomEnemys[4].alive = false;
    randomEnemys[4].charHp = 0;

    enemyText[4].setText(randomEnemys[4].name + "\n" + "HP: " + randomEnemys[4].charHp);
    toggleVisible();

    randomEnemys.splice(4,1);
    enemyText.splice(4,1);

    next_turn();
  }
  enemyText[4].setText(randomEnemys[4].name + "\n" + "HP: " + randomEnemys[4].charHp);
  toggleVisible();
  next_turn();
}

// var act = function(unit){
//   if(unit.isNpc == false){
//     button.visible = true;
//     //console.log(button.visible);
//     console.log("player does something");
//   }
//   if(unit.isNpc == true){
//     button.visble = false;
//     console.log("enemy does something");
//   }
// }

var changeWorldState = function(){
  game.state.start('worldMap');
}