var cursors;
var attackButton;
var charObj;
var charText = [];
var deadCharText = [];

var enemyText = [];

var enemyButton1;
var enemyButton2;
var enemyButton3;
var enemyButton4;
var enemyButton5;

var current_unit;

var deadChars = [];

var charsArray = [
      {
        name: "Clarence", 
        unitType: "Warrior", 
        unitHp: 400, 
        unitAttack: 20, 
        alive: true, 
        isNpc: false,
        act: function(){
          if(this.isNpc == false){
            attackButton.visible = true;
            //console.log(attackButton.visible);
          }
          if(this.isNpc == true){
            attackButton.visble = false;
          }
        }
      },
      {
        name: "Bob", 
        unitType: "Rogue", 
        unitHp: 200, 
        unitAttack: 40, 
        alive: true, 
        isNpc: false,
        act: function(){
          if(this.isNpc == false){
            attackButton.visible = true;
            //console.log(attackButton.visible);
          }
          if(this.isNpc == true){
            attackButton.visble = false;
          }
        }
      },
      {
        name: "Nyan Cat", 
        unitType: "Beast Tamer", 
        unitHp: 200, 
        unitAttack: 60, 
        alive: true, 
        isNpc: false,
        act: function(){
          if(this.isNpc == false){
            attackButton.visible = true;
            //console.log(attackButton.visible);
          }
          if(this.isNpc == true){
            attackButton.visble = false;
          }
        }
      },
      {
        name: "Chewy", 
        unitType: "Wookie", 
        unitHp: 300, 
        unitAttack: 100, 
        alive: true, 
        isNpc: false,
        act: function(){
          if(this.isNpc == false){
            attackButton.visible = true;
            //console.log(attackButton.visible);
          }
          if(this.isNpc == true){
            attackButton.visble = false;
          }
        }
      }
    ];

var enemysArray = [
      {
        name: "The Blob", 
        unitType: "Slime", 
        unitHp: 200, 
        unitAttack: 20, 
        alive: true, 
        isNpc: true,
        act: function(){
          if(this.isNpc == false){
            attackButton.visible = true;
            //console.log(attackButton.visible);
          }
          if(this.isNpc == true){
            attackButton.visble = false;
            arrayLength = charsArray.length;

            var charIndex = Math.floor(Math.random() * arrayLength);

            charsArray[charIndex].unitHp = charsArray[charIndex].unitHp - current_unit.unitAttack;

            if(charsArray[charIndex].unitHp < 1){
              charsArray[charIndex].alive = false;
              charsArray[charIndex].unitHp = 0;
              console.log("IT attacks " + charsArray[charIndex].name);
              charText[charIndex].setText(charsArray[charIndex].name + "\n" + charsArray[charIndex].unitHp);
              deadChars.push(charsArray.splice(charIndex,1));
              deadCharText.push(charText.splice(charIndex,1));
              return;
            }

            console.log("IT attacks " + charsArray[charIndex].name);
            charText[charIndex].setText(charsArray[charIndex].name + "\n" + charsArray[charIndex].unitHp);
            //next_turn();
          }
        }
      },
      {
        name: "Clamps", 
        unitType: "Robot", 
        unitHp: 400, 
        unitAttack: 50, 
        alive: true, 
        isNpc: true,
        act: function(){
          if(this.isNpc == false){
            attackButton.visible = true;
            //console.log(attackButton.visible);
          }
          if(this.isNpc == true){
            attackButton.visble = false;
            arrayLength = charsArray.length;

            var charIndex = Math.floor(Math.random() * arrayLength);

            charsArray[charIndex].unitHp = charsArray[charIndex].unitHp - current_unit.unitAttack;

            if(charsArray[charIndex].unitHp < 1){
              charsArray[charIndex].alive = false;
              charsArray[charIndex].unitHp = 0;
              console.log("IT attacks " + charsArray[charIndex].name);
              charText[charIndex].setText(charsArray[charIndex].name + "\n" + charsArray[charIndex].unitHp);
              deadChars.push(charsArray.splice(charIndex,1));
              deadCharText.push(charText.splice(charIndex,1));
              return;
            }

            console.log("IT attacks " + charsArray[charIndex].name);
            charText[charIndex].setText(charsArray[charIndex].name + "\n" + charsArray[charIndex].unitHp);
            //next_turn();
          }
        }
      },
      {
        name: "Scrooge", 
        unitType: "Person", 
        unitHp: 500, 
        unitAttack: 40, 
        alive: true, 
        isNpc: true,
        act: function(){
          if(this.isNpc == false){
            attackButton.visible = true;
            //console.log(attackButton.visible);
          }
          if(this.isNpc == true){
            attackButton.visble = false;

            arrayLength = charsArray.length;

            var charIndex = Math.floor(Math.random() * arrayLength);

            charsArray[charIndex].unitHp = charsArray[charIndex].unitHp - current_unit.unitAttack;

            if(charsArray[charIndex].unitHp < 1){
              charsArray[charIndex].alive = false;
              charsArray[charIndex].unitHp = 0;
              console.log("IT attacks " + charsArray[charIndex].name);
              charText[charIndex].setText(charsArray[charIndex].name + "\n" + charsArray[charIndex].unitHp);
              deadChars.push(charsArray.splice(charIndex,1));
              deadCharText.push(charText.splice(charIndex,1));
              return;
            }

            console.log("IT attacks " + charsArray[charIndex].name);
            charText[charIndex].setText(charsArray[charIndex].name + "\n" + charsArray[charIndex].unitHp);
            //next_turn();
          }
        }
      },
      {
        name: "Mr Crab", 
        unitType: "Crab", 
        unitHp: 300, 
        unitAttack: 50, 
        alive: true, 
        isNpc: true,
        act: function(){
          if(this.isNpc == false){
            attackButton.visible = true;
            //console.log(attackButton.visible);
          }
          if(this.isNpc == true){
            attackButton.visble = false;

            arrayLength = charsArray.length;

            var charIndex = Math.floor(Math.random() * arrayLength);

            charsArray[charIndex].unitHp = charsArray[charIndex].unitHp - current_unit.unitAttack;

            if(charsArray[charIndex].unitHp < 1){
              charsArray[charIndex].alive = false;
              charsArray[charIndex].unitHp = 0;
              console.log("IT attacks " + charsArray[charIndex].name);
              charText[charIndex].setText(charsArray[charIndex].name + "\n" + charsArray[charIndex].unitHp);
              deadChars.push(charsArray.splice(charIndex,1));
              deadCharText.push(charText.splice(charIndex,1));
              return;
            }

            console.log("IT attacks " + charsArray[charIndex].name);
            charText[charIndex].setText(charsArray[charIndex].name + "\n" + charsArray[charIndex].unitHp);
            //next_turn();
          }
        }
      },
      {
        name: "IT", 
        unitType: "Clown", 
        unitHp: 100, 
        unitAttack: 100, 
        alive: true, 
        isNpc: true,
        act: function(){
          if(this.isNpc == false){
            attackButton.visible = true;
            //console.log(attackButton.visible);
          }
          if(this.isNpc == true){
            attackButton.visble = false;

            arrayLength = charsArray.length;

            var charIndex = Math.floor(Math.random() * arrayLength);

            charsArray[charIndex].unitHp = charsArray[charIndex].unitHp - current_unit.unitAttack;

            if(charsArray[charIndex].unitHp < 1){
              charsArray[charIndex].alive = false;
              charsArray[charIndex].unitHp = 0;
              console.log("IT attacks " + charsArray[charIndex].name);
              charText[charIndex].setText(charsArray[charIndex].name + "\n" + charsArray[charIndex].unitHp);
              deadChars.push(charsArray.splice(charIndex,1));
              deadCharText.push(charText.splice(charIndex,1));
              return;
            }

            console.log("IT attacks " + charsArray[charIndex].name);
            charText[charIndex].setText(charsArray[charIndex].name + "\n" + charsArray[charIndex].unitHp);
            //next_turn();


            // for(var i = 0; i < charsArray.length; i++){
            //   if(charsArray[i].unitHp >= 1){
            //     charsArray[i].unitHp = charsArray[i].unitHp - current_unit.unitAttack;
            //     if(charsArray[i].unitHp < 1){
            //       charsArray[i].alive = false;
            //       charsArray[i].unitHp = 0;
            //     }
            //     console.log("IT attacks " + charsArray[i].name);
            //     charText[i].setText(charsArray[i].name + "\n" + charsArray[i].unitHp);
            //     next_turn();
            //   }
            // }
            console.log("IT acted");
            //game.state.start('loseState');
          }
        }
      }
    ];

var unitsArray = charsArray.concat(enemysArray);

var actionMenu;
var enemyMenu;
var itemMenu;

var characters;

var battleState = {
  preload: function(){
    //game.cache.destroy();
    game.load.image('background','<%= asset_path "battle_background.png" %>');
    game.load.image('star','<%= asset_path "star.png" %>');
    game.load.image('attack','<%= asset_path "attack_button.png" %>');
    game.load.spritesheet('dude','<%= asset_path "dude.png" %>',32,48);


    // characters = fetch('http://localhost:3000/characters.json')
    //   .then(function(response){
    //     return response.json();
    //   })
    //   .then(function(data){
    //     charObj = {
    //       name: data[0].character_name,
    //       charClass: data[0].character_class,
    //       charHp: 300,
    //       charAttack: data[0].attack,
    //       alive: true
    //     };

    //     //gameUnits.push(charObj);

    //     charText = game.add.text(50, 400,charObj.name + "\n" + charObj.charClass + "\n" + charObj.charHp, {font: "30px Arial", fill: "#ffffff", align: "center"});   

    //   });
  },
  create: function(){
    game.physics.startSystem(Phaser.Physics.ARCADE);
    game.add.sprite(0,0,'background');

    actionMenu = game.add.group();
    enemyMenu = game.add.group();
    itemMenu = game.add.group();

    //set up enemy and char array over here

    enemyButton1 = game.add.button(340,366,'attack');
    enemyButton2 = game.add.button(340,400,'attack');
    enemyButton3 = game.add.button(340,440,'attack');
    enemyButton4 = game.add.button(340,480,'attack');
    enemyButton5 = game.add.button(340,520,'attack');

    enemyButton1.onInputUp.add(attackEnemyOne,this);
    enemyButton2.onInputUp.add(attackEnemyTwo,this);
    enemyButton3.onInputUp.add(attackEnemyThree,this);
    enemyButton4.onInputUp.add(attackEnemyFour,this);
    enemyButton5.onInputUp.add(attackEnemyFive,this);

    enemyButton1.visible = false;
    enemyButton2.visible = false;
    enemyButton3.visible = false;
    enemyButton4.visible = false;
    enemyButton5.visible = false;

    //enemyButton1.onInputUp.add(attackFunction,this);

    attackButton = game.add.button(560,366,'attack');

    attackButton.onInputUp.add(attackFunction, this);

    for(var i = 0; i < enemysArray.length; i++){
         enemyText.push(game.add.text((120*i)+20, 20,enemysArray[i].name + "\n" + enemysArray[i].unitHp, {font: "30px Arial", fill: "#ffffff", align: "center"}));
    }

    for(var i = 0; i < charsArray.length; i++){
         charText.push(game.add.text((120*i)+20, 200,charsArray[i].name + "\n" + charsArray[i].unitHp, {font: "30px Arial", fill: "#ffffff", align: "center"}));
    }

    actionMenu.add(attackButton);

    next_turn();

    //cursors = game.input.keyboard.createCursorKeys();

  },
  update: function(){
    if(!isAlive(charsArray)){
      game.state.start('loseState');
    }

    if(!isAlive(enemysArray)){
      game.state.start(game.cache.currentGameState);
    }
  }
};

var attackFunction = function(numbers){

  //enemyHolder.unitHp = enemyHolder.unitHp - charHolder.unitAttack;
  toggleVisible();
 
}

var isAlive = function(arrayToCheck){
  var arrayLength = arrayToCheck.length;
  var totalHp = 0;
  var unitsAlive = true;

  for(var i = 0; i < arrayLength; i++){
    totalHp += arrayToCheck[i].unitHp;
  }

  if(totalHp < 1){
    unitsAlive = false;
  }

  return unitsAlive;
}


var next_turn = function(){
  current_unit = unitsArray.shift();

  console.log(current_unit.name + " " +current_unit.alive);

  console.log(unitsArray);


  if(current_unit.alive){
    current_unit.act();
    console.log(current_unit.name + " does something");
    unitsArray.push(current_unit);
    if(current_unit.isNpc == true){
      next_turn();
    }
  }
  else{
    next_turn();
  }
}

var toggleVisible = function(){
  if(enemysArray.length == 1){
    enemyButton1.visible = !enemyButton1.visible;
  }
  else if(enemysArray.length == 2){
    enemyButton1.visible = !enemyButton1.visible;
    enemyButton2.visible = !enemyButton2.visible;
  }
  else if(enemysArray.length == 3){
    enemyButton1.visible = !enemyButton1.visible;
    enemyButton2.visible = !enemyButton2.visible;
    enemyButton3.visible = !enemyButton3.visible;
  }
  else if(enemysArray.length == 4){
    enemyButton1.visible = !enemyButton1.visible;
    enemyButton2.visible = !enemyButton2.visible;
    enemyButton3.visible = !enemyButton3.visible;
    enemyButton4.visible = !enemyButton4.visible;
  }
  else{
    enemyButton1.visible = !enemyButton1.visible;
    enemyButton2.visible = !enemyButton2.visible;
    enemyButton3.visible = !enemyButton3.visible;
    enemyButton4.visible = !enemyButton4.visible;
    enemyButton5.visible = !enemyButton5.visible;
  }
}

var attackEnemyOne = function(){
  enemysArray[0].unitHp = enemysArray[0].unitHp - current_unit.unitAttack;
  if(enemysArray[0].unitHp < 1){
    enemysArray[0].alive = false;
    enemysArray[0].unitHp = 0;
  }
  enemyText[0].setText(enemysArray[0].name + "\n" + enemysArray[0].unitHp);
  next_turn();
}

var attackEnemyTwo = function(){
  enemysArray[1].unitHp = enemysArray[1].unitHp - current_unit.unitAttack;
  if(enemysArray[1].unitHp < 1){
    enemysArray[1].alive = false;
    enemysArray[1].unitHp = 0;
  }
  enemyText[1].setText(enemysArray[1].name + "\n" + enemysArray[1].unitHp);
  next_turn();
}

var attackEnemyThree = function(){
  enemysArray[2].unitHp = enemysArray[2].unitHp - current_unit.unitAttack;
  if(enemysArray[2].unitHp < 1){
    enemysArray[2].alive = false;
    enemysArray[2].unitHp = 0;
  }
  enemyText[2].setText(enemysArray[2].name + "\n" + enemysArray[2].unitHp);
  next_turn();
}

var attackEnemyFour = function(){
  enemysArray[3].unitHp = enemysArray[3].unitHp - current_unit.unitAttack;
  if(enemysArray[3].unitHp < 1){
    enemysArray[3].alive = false;
    enemysArray[3].unitHp = 0;
  }
  enemyText[3].setText(enemysArray[3].name + "\n" + enemysArray[3].unitHp);
  next_turn();
}

var attackEnemyFive = function(){
  enemysArray[4].unitHp = enemysArray[4].unitHp - current_unit.unitAttack;
  if(enemysArray[4].unitHp < 1){
    enemysArray[4].alive = false;
    enemysArray[4].unitHp = 0;
  }
  enemyText[4].setText(enemysArray[4].name + "\n" + enemysArray[4].unitHp);
  next_turn();
}

// var act = function(unit){
//   if(unit.isNpc == false){
//     button.visible = true;
//     //console.log(button.visible);
//     console.log("player does something");
//   }
//   if(unit.isNpc == true){
//     button.visble = false;
//     console.log("enemy does something");
//   }
// }

var changeWorldState = function(){
  game.state.start('worldMap');
}